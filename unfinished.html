<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial, viewport-fit=cover">
  <title>Unfinished Business - Home</title>

  <style>
    /*******************************************
     * FONTS
     ********************************************/
    /* Louise Regular */
    @font-face {
      font-family: 'Louise-Regular';
      src: url('fonts/VTF/otf/Louise-Regular.otf') format('opentype'),
           url('fonts/VTF/ttf/Louise-Regular.ttf') format('truetype'),
           url('fonts/VTF/webfonts/Louise-Regular.woff') format('woff'),
           url('fonts/VTF/webfonts/Louise-Regular.woff2') format('woff2');
      font-style: normal;
    }
    /* Latitude Regular */
    @font-face {
      font-family: 'Latitude-Regular';
      src: url('fonts/VTF/otf/Latitude-Regular.otf') format('opentype'),
           url('fonts/VTF/ttf/Latitude-Regular.ttf') format('truetype'),
           url('fonts/VTF/webfonts/Latitude-Regular.woff') format('woff'),
           url('fonts/VTF/webfonts/Latitude-Regular.woff2') format('woff2');
      font-style: normal;
    }
    /* Director Regular */
    @font-face {
      font-family: 'Director-Regular';
      src: url('fonts/VTF/otf/Director-Regular.otf') format('opentype'),
           url('fonts/VTF/ttf/Director-Regular.ttf') format('truetype'),
           url('fonts/VTF/webfonts/Director-Regular.woff') format('woff'),
           url('fonts/VTF/webfonts/Director-Regular.woff2') format('woff2');
      font-style: normal;
    }






    /*******************************************
     * GLOBAL RESET & BASE STYLES
     ********************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      overflow-x: hidden;      
      touch-action: manipulation;
      min-height: 100%;
      background-color: #d0baff;
    }
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      padding: 3vw;
    }
    body.lock-scroll {
      overflow: hidden;
      position: relative;
      height: 100vh; 
    }
    #backButton {
      position: fixed;
      padding: 1vw 1.5vw;
      top: 0;
      left: 0;
      font-size: 1.2vw;
      border-radius: 0 0 20px 0;
      font-weight: 700;
      background-color: #c4ea3a;
      border: none;
      color: #541c47;
      cursor: pointer;
      z-index: 100000; 
    }









    /*******************************************
     * HEADER
     ********************************************/
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #0b443c;
      position: relative;
      border-radius: 90px;
      margin: 0 0 3vw 0;
    }
    header h1 {
      font-size: 6rem;
      font-weight: 300;
      padding: 2vw 4vw 2vw 4vw;
      color: #d0baff;
      user-select: none;
      display: flex;
      flex-wrap: wrap;
    }
    header a {
      border-radius: 0 0 0 20px;
      text-decoration: none;
      padding: 2vw;
      margin: 3vw;
      background: #c4ea3a;
      color: #541c47;

      transition: background-color 0.3s ease;
      font-size: 1rem;
      font-weight: bold;
      position: absolute;
      right: 0;
      top: 0;
      height: auto;
      width: auto;
      text-align: center;
      cursor: pointer;
    }
    header a:hover {
      background: #1c171b;
      color: #ebebeb;
    }
    .letter {
      opacity: 0;
      transition: opacity 0.3s ease;
      display: inline-block;
    }
    .visible {
      opacity: 1;
    }










    /*******************************************
     * ABOUT SECTION
     ********************************************/
    #about {
      height: fit-content;
      color: #0b443c;
      background-color: #c4ea3a;
      padding: 2vw 3vw 1vw 3vw;
      line-height: 2.2rem;
      font-size: 1.7rem;
      font-weight: 300;
      border-radius: 40px 40px 0 0;
    }












    /*******************************************
     * TOP MENU BAR
     ********************************************/
    #topMenuBar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1vw 3vw 2.5vw 3vw;
      color: #0b443c;
      background-color: #c4ea3a;
      border-radius: 0 0 40px 40px;
    }
    #layoutToggleBtn, #searchInput {
      font-size: 1rem;
      border: none;
      background-color: #0b443c;
      color: #d0baff;
      padding: 0.9rem 1.4rem;
      border-radius: 30px;
    }
    #layoutToggleBtn:hover {
      background-color: #291528;
      color: #ebebeb;
    }
    #searchInput {
      flex: 1;
      max-width: 300px;
      color: #541c47;
    }





    /*******************************************
     * FILTER RESULTS
     ********************************************/
/* Wrapper for custom select */
.custom-select-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
  border-radius: 0;
  max-width: 300px; /* Adjust the width as needed */
  border: none;
}

/* Style the dropdown */
#tagsDropdown {
  border-radius: 40px;
  width: 100%;
  border: none;
  padding: 0.9rem 2.9rem 0.9rem 0.9rem; /* Space for arrow */
  font-size: 1rem;
  background-color: #0b443c;
  color: #541c47;
  appearance: none; /* Remove native arrow */
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  transition: background-color 0.3s, color 0.3s;
}

/* Add the down arrow */
.custom-select-wrapper::after {
  content: '▼'; /* Down arrow symbol */
  position: absolute;
  top: 50%;
  border: none;
  border-radius: 0;
  right: 1rem;
  transform: translateY(-50%);
  pointer-events: none; /* Allows clicks to pass through */
  color: #ebebeb;
  font-size: 0.8rem;
}

/* Change arrow color on hover */
.custom-select-wrapper::after {
  color: #4b4b4b; /* Lighter blue on hover */
  border: none;
}

/* Style for placeholder (disabled option) */
#tagsDropdown option:disabled {
  color: #4b4b4b; /* Gray color for placeholder text */
  border: none;
}

/* Change background and text color when a valid option is selected */
#tagsDropdown:invalid {
  background-color: #0b443c;
  color: #d0baff;
  border: none;
}

#tagsDropdown:valid {
  background-color: #291528; /* Pale blue */
  color: #ebebeb; /* Dark text */
  border: none;
}

/* Optional: Focus state */
#tagsDropdown:focus {
  outline: none;
}















    /*******************************************
     * PROJECT LIST (grid vs scatter)
     ********************************************/
    #projectList {
      /* For scatter, we'll size/position absolutely. For grid, we override. */
      width: 100%;
      height: 120vh;
      overflow: hidden;
      border-radius: 0 0 40px 40px;
background-color: #d0baff;
      display: block; /* fallback for scatter */
      position: relative; /* container context for scatter movement */
    }
    #projectList.grid-mode {
  padding: 5vw;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-auto-rows: 1fr;
  gap: 4rem; /* Adjust spacing between projects */
  height: auto; /* Let the container size adjust based on content */
}

#projectList.grid-mode .project {
  width: 100%; /* Projects will automatically size based on the grid */
  min-height: 26vw;
  height: auto;
  cursor: default;
  transform: none !important;
  transition: transform 0.3s ease, background-color 0.3s ease;
}

#projectList.grid-mode .project:hover {
  transform: scale(1.05);
}












    /*******************************************
     * PROJECT CARD
     ********************************************/
    /* IMPORTANT: We set position: relative so .image-overlay can anchor properly. */
    .project {
      position: relative; /* anchors .image-overlay within each card */
      cursor: grab;
      user-select: none;
      border-radius: 22px;
      width: 300px;
      min-height: 300px;
      overflow: hidden;
      background-color: #e8ddff;
      color: #0b443c;
      padding: 2rem;
      box-sizing: border-box;
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    /* This class is added in scatter mode for absolute positioning inside #projectList */
    .scattered {
      position: absolute !important;
    }

    /* In grid-mode, no scatter; we remove .scattered so they flow in normal layout */
    #projectList.grid-mode .project {
      cursor: default;
      transform: none !important;
    }

    .project:hover {
      transform: scale(1.02);
    }











    /*******************************************
     * UPVOTE
     ********************************************/

    /* Upvote container (top-right corner of the project card) */
    .upvote-container {
      position: absolute;
      top: 0;
      right: 0;
      background-color: #c4ea3a;
      border-radius: 0 20px 0 20px;
      color: #541c47;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.8rem;
      z-index: 3; /* ensure upvote area is above overlay */
    }
    .upvoteBtn {
      cursor: pointer;
      color: #541c47; /* Default color */
      background: none;
      border: none;
      font-size: 1.2rem;
      font-weight: bold;
      transition: color 0.3s ease;
    }

    .upvoteBtn:hover:not(:disabled) {
      color: #ee7f00; /* Hover color for active buttons */
    }

    .upvoteBtn.clicked {
      color: #ee7f00; /* Color after clicking (gold) */
      cursor: not-allowed;
      pointer-events: none; /* Ensure it's not clickable */
    }













    /**************************
     Project info style 
     *************************/
    .project-info {
      position: relative;
      z-index: 2;
      pointer-events: none;
      opacity: 1;
    }
    .title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.9rem;
      color: #0b443c;
    }
    .description {
      font-size: 1rem;
      line-height: 1.4rem;
      margin-bottom: 0.9rem;
      color: #0b443c;
    }
    .tags {
      font-size: 0.9rem;
      font-style: italic;
      color: #0b443c;
    }














    /*******************************************
     * IMAGE OVERLAY
     ********************************************/
    .has-image {
      background-color: #291528;
      color: #d0baff;
    }

  
    .has-image .title,
    .has-image .description,
    .has-image .tags {
      color: #c4d8ff;
    }
    .has-image .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #291528;
      opacity: 1;
      transition: opacity 0.4s ease-in-out;
      z-index: 1;
    }

    .has-image:hover .image-overlay {
      opacity: 0;
    }
    .has-image .project-info {
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
    }
    .has-image:hover .project-info {
      opacity: 1;
    }











    /*******************************************
     * VISUAL FEEDBACK (scatter mode)
     ********************************************/
    .dragging {
      transform: scale(1.1) rotate(1deg);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
      cursor: grabbing;
    }
    .dropped {
      animation: bounce 2s ease;
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }











    /*******************************************
     * PAGINATION BUTTONS
     ********************************************/
    .pagination-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
    }
    .pagination-buttons button {
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      border: none;
      background-color: #ebebeb;
      border-radius: 30px;
      color: #1c171b;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .pagination-buttons button:hover:enabled {
      background: #0b443c;
      color: #ebebeb;
    }
    .pagination-buttons button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }












    /*******************************************
     * SUBMISSION FORM (DESKTOP-ONLY SLIDE DOWN)
     ********************************************/
    #submissionFormContainer {
      position: fixed;
      top: 0;
      right: 0;
      width: 40vw;
      height: 100%;
      min-width: 350px;
      background-color: #0b443c;
      transform: translateY(-120%);
      transition: transform 0.5s ease;
      z-index: 9999999;
      padding: 2rem;
      overflow-y: auto;
    }
    #submissionFormContainer.open {
      transform: translateY(0);
    }
    #closeFormButton {
      position: absolute;
      top: 0;
      right: 0;
      border: none;
      background-color: #0b443c;
      border-radius: 0 0 0 30px;
      color: #ebebeb;
      cursor: pointer;
      font-size: 1rem;
      padding: 1.3rem 1.3rem 1.5rem 1.5rem;
    }
    #closeFormButton:hover {
      background-color: #ebebeb;
      color: #1c171b;
    }
    #uploadForm {
      color: #ebebeb;
      padding: 2rem;
    }
    #uploadForm h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #ebebeb;
    }
    #uploadForm label {
      font-weight: 600;
      display: inline-block;
      margin-bottom: 0.5rem;
      color: #ebebeb;
    }
    #uploadForm input[type="text"],
    #uploadForm textarea {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 1.5rem;
      border: none;
      background-color: #1c171b;
      color: #ebebeb;
      border-radius: 0;
      font-size: 1rem;
      font-family: inherit;
      border-radius: 10px;
    }
    #file {
      display: none; 
    }




    #toggleFormButton {
      position: fixed;
      margin: 0;
      z-index: 100;
      top: 0;
      right: 0;
    }
    #drawToggleBtn,
    #uploadForm button[type="submit"] {
      cursor: pointer;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      transition: background-color 0.3s;
      margin-right: 1rem;
      margin-bottom: 0.4rem;
      border-radius: 20px;
    }
    #drawToggleBtn {
      background-color: #1c171b;
      color: #fffac4;
    }
    #uploadForm button[type="submit"] {
      background-color: #fffac4;
      color: #1c171b;
    }
    #drawToggleBtn:hover {
      background-color: #fffac4;
      color: #1c171b;
    }
    #uploadForm button[type="submit"]:hover {
      background-color: #8797b7;
      color: #1c171b;
      border: 1px solid #8797b7;
    }

    #drawContainer {
      display: none;
      margin-bottom: 1.5rem;
    }
    #drawCanvas {
      background: #000;
      border: none;
      width: 300px;
      border-radius: 20px;
      height: 300px;
      display: block;
      margin-top: 1rem;
      cursor: crosshair;
    }

    #statusMessage {
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
      color: #fffac4;
    }







/*************************
Privay Check box
***************************/


    .privacy-checkbox-container {
      margin: 1rem 0;
      color: #fffac4; 
      font-size: 0.9rem;
    }
    .privacy-checkbox-container input[type="checkbox"] {
      width: 1rem; 
      height: 1rem;
      margin-right: 0.2rem;
      margin-bottom: 0.3rem;
      background-color: #1c171b;
      color: #fffac4; 
      cursor: pointer;
      appearance: none;
      display: inline-block;
      vertical-align: middle;
      position: relative;
    }
    .privacy-checkbox-container input[type="checkbox"]::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 5px;
      width: 4px;
      height: 8px;
      border: solid #fffac4; /* Use the desired color */
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      display: none;
    }
    .privacy-checkbox-container input[type="checkbox"]:checked::after {
      display: block;
    }
    .privacy-checkbox-container input[type="checkbox"]:focus {
      outline: none;
    }
    .privacy-checkbox-container label {
      cursor: pointer;
      color: #fffac4; 
      line-height: 1.4rem;
      font-weight: 300 !important;
      font-style: italic;
      font-family: inherit;
      color: inherit;
    }








    /*******************************************
     * RESPONSIVE TWEAKS FOR MOBILE
     ********************************************/
    @media (max-width: 600px) {
      #submissionFormContainer {
        position: fixed; 
        top: 0; 
        left: 0;
        width: 100vw; 
        height: 100vh;
        overflow-y: auto;
      }
      body {
        padding: 15vw 3vw;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      #backButton {
        font-size: 5vw;
        padding: 2vw;
      }
      header h1 {
        font-size: 2rem;
      }
      header a {
        font-size: 1rem;
        background-color: #c4ea3a;
        color: #541c47;
        z-index: 10000;
        top:0;
        right: 0;
        height: fit-content;
        position: fixed;
        padding: 3.3vw;
        margin: 0;
        width: fit-content;
      }
      .project {
        width: 60vw !important;   /* single column on mobile */
        height: 60vw !important;
        margin: 1rem auto 5rem auto;     
      }
      .has-image .image-overlay {
        background-size: cover;
      }
      .title {
        font-size: 1rem;
      }
      .description {
        font-size: 0.8rem;
      }
      .tags {
        font-size: 0.7rem;
      }
      #drawCanvas {
        width: 45vw;
        height: 45vw;
      }
      #about {
        padding: 20px;
        font-size: 1.3rem;
        line-height: 2rem;
      }
      .pagination-buttons {
        flex-direction: column;
      }
      #topMenuBar {
        flex-direction: column;
        align-items: stretch;
      }
      #searchInput {
        max-width: 100%;
        margin-top: 0.5rem;
      }
      
      #projectList.grid-mode {
  padding: 10vw;
  display: inline-block;
  height: auto; /* Let the container size adjust based on content */
}


#layoutToggleBtn {
  display: none;
}

    }
  </style>
</head>

<body>
  <!-- ----------- HEADER ----------- -->
  <header>
    <h1 id="animated-title">
      <span class="letter hidden">U</span>
      <span class="letter hidden">n</span>
      <span class="letter hidden">f</span>
      <span class="letter hidden">i</span>
      <span class="letter hidden">n</span>
      <span class="letter hidden">i</span>
      <span class="letter hidden">s</span>
      <span class="letter hidden">h</span>
      <span class="letter hidden">e</span>
      <span class="letter hidden">d</span>
      <span class="letter hidden">&nbsp;</span>
      <span class="letter hidden">B</span>
      <span class="letter hidden">u</span>
      <span class="letter hidden">s</span>
      <span class="letter hidden">i</span>
      <span class="letter hidden">n</span>
      <span class="letter hidden">e</span>
      <span class="letter hidden">s</span>
      <span class="letter hidden">s</span>
      <span class="letter hidden">.</span>
      <span class="letter hidden">.</span>
      <span class="letter hidden">.</span>
    </h1>
    <a id="toggleFormButton">Submit</a>
  </header>

  <button id="backButton" onclick="history.back();">&#x2190;</button>

  <!-- Info section -->
  <div id="about">
    <p>
      Unfinished business is a home for half baked ideas. Submit a concept that isnt quite finished, 
      mock up a painting that isnt quite ready, formulate an idea that might sound stupid. This is not the place for polish.
      This is the place to explore the journey — not the destination.
    </p>
  </div>

<!-- =========== NEW MENU BAR =========== -->
<div id="topMenuBar">
  <!-- Layout toggle -->
  <button id="layoutToggleBtn">Switch to Scatter</button>
  
  <!-- Search -->
  <input type="text" id="searchInput" placeholder="Search projects..." />
  
  <!-- Tags dropdown with custom styling -->
  <div class="custom-select-wrapper">
    <select id="tagsDropdown" required>
      <option value="" disabled selected>Search Tags</option>
      <option value="All">All</option>
      <!-- Dynamically populated options will be inserted here -->
    </select>
  </div>
</div>

  <!-- Project List Container -->
  <div id="projectList">Loading...</div>

  <!-- Pagination Buttons: "Previous" & "Next" -->
  <div class="pagination-buttons">
    <button id="prevPageBtn" disabled>Previous Page</button>
    <button id="nextPageBtn" disabled>Next Page</button>
  </div>

  <!-- ========== DESKTOP-ONLY SLIDE-DOWN FORM ========== -->
  <div id="submissionFormContainer">
    <!-- Close (X) button -->
    <button id="closeFormButton">X</button>

    <form id="uploadForm">
      <h2>Submit a half baked idea...</h2>

      <div>
        <label for="title">Title</label><br />
        <input type="text" id="title" name="title" required />
      </div>

      <div>
        <label for="description">Description</label><br />
        <textarea id="description" name="description" rows="4" required></textarea>
      </div>

      <div>
        <label for="tags">Tags (comma separated)</label><br />
        <input type="text" id="tags" name="tags" placeholder="e.g. art, WIP, concept" />
      </div>

      <!-- Hidden file input (optional) -->
      <input type="file" id="file" name="file" accept="image/*" />

      <!-- Collapsible draw canvas trigger -->
      <button type="button" id="drawToggleBtn">Draw &#8595;</button>

      <!-- Collapsible container with canvas -->
      <div id="drawContainer">
        <canvas id="drawCanvas" width="400" height="400"></canvas>
      </div>

      <!-- Privacy notice checkbox -->
      <div class="privacy-checkbox-container">
        <label for="privacyCheck">
          <input 
            type="checkbox" 
            id="privacyCheck" 
            required 
          /> 
          Unfinished Business is an anonymous public platform. No identifying information is stored unless you choose to disclose it. Uploads can only be removed upon request. By submitting, you agree to these terms.
        </label>
      </div>

      <button type="submit">Submit</button>
    </form>

    <p id="statusMessage"></p>
  </div>
  <!-- ========== END SUBMISSION FORM ========== -->

  <!-- ----------- Supabase & JS Logic ----------- -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Supabase details
    const SUPABASE_URL = "https://dxvznqxwdbrcyyoadbgb.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4dnpucXh3ZGJyY3l5b2FkYmdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NjUzMzIsImV4cCI6MjA1MDU0MTMzMn0.FbSmgJ5KOGaSIY4150gOIbiYWQ86fbtZQk-fP50RkZk";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Layout mode: grid by default
    let isGridView = true;

    // Scatter (draggable) tracking
    let savedPositions = [];
    let isDragging = false;
    let activeElement = null;
    let offsetX = 0,
        offsetY = 0;
    let velocityX = 0,
        velocityY = 0;
    const friction = 0.95;
    let zIndexCounter = 1000;

    // Pagination
    let currentPage = 1;  
    const PAGE_SIZE = 6;
    let totalLastPage = 1;   

    // Filter state
    let currentFilterTag = null; // "All" => null
    let searchTerm = "";         // used for text search

    // DOM references
    const projectListEl = document.getElementById("projectList");
    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");

    const layoutToggleBtn = document.getElementById("layoutToggleBtn");
    const searchInput = document.getElementById("searchInput");
    const tagsDropdown = document.getElementById("tagsDropdown");

    // Form references
    const submissionFormContainer = document.getElementById('submissionFormContainer');
    const toggleFormButton = document.getElementById('toggleFormButton');
    const closeFormButton = document.getElementById('closeFormButton');
    const uploadForm = document.getElementById('uploadForm');
    const drawToggleBtn = document.getElementById('drawToggleBtn');
    const drawContainer = document.getElementById('drawContainer');
    const statusMessage = document.getElementById('statusMessage');
    const drawCanvas = document.getElementById('drawCanvas');
    const ctx = drawCanvas.getContext('2d');






    // ------------------ LAYOUT TOGGLE ------------------
    layoutToggleBtn.addEventListener("click", () => {
      isGridView = !isGridView;
      if (isGridView) {
        layoutToggleBtn.textContent = "Switch to Scatter";
        projectListEl.classList.add("grid-mode");
      } else {
        layoutToggleBtn.textContent = "Switch to Grid";
        projectListEl.classList.remove("grid-mode");
      }
      // Re-render the current page, re-randomize positions if scatter
      renderPage(currentPage, true);
    });





    // ------------------ SEARCH BAR ------------------
    searchInput.addEventListener("input", () => {
      searchTerm = searchInput.value.trim();
      currentPage = 1;
      renderPage(currentPage);
    });







    // ------------------ TAGS DROPDOWN ------------------
    tagsDropdown.addEventListener("change", () => {
      const val = tagsDropdown.value;
      if (val === "All") {
        currentFilterTag = null;
      } else {
        currentFilterTag = val;
      }
      currentPage = 1;
      renderPage(currentPage);
    });








    // ------------------ FORM TOGGLE ------------------
    toggleFormButton.addEventListener('click', () => {
      submissionFormContainer.classList.add('open');
      if (window.innerWidth <= 600) {
        document.body.classList.add('lock-scroll');
      }
    });
    closeFormButton.addEventListener('click', () => {
      submissionFormContainer.classList.remove('open');
      if (window.innerWidth <= 600) {
        document.body.classList.remove('lock-scroll');
      }
    });






    // ------------------ DRAWING SETUP ------------------
    ctx.strokeStyle = "#c4d8ff";
    ctx.lineWidth = 1;
    ctx.lineCap = "round";
    let drawing = false;
    drawContainer.style.display = "none";

    drawToggleBtn.addEventListener("click", () => {
      const isHidden = drawContainer.style.display === "none";
      drawContainer.style.display = isHidden ? "block" : "none";
      drawToggleBtn.innerHTML = isHidden ? 'Hide &#8593;' : 'Draw &#8595;';
    });

    function getScaledCoords(clientX, clientY) {
      const rect = drawCanvas.getBoundingClientRect();
      const scaleX = drawCanvas.width / rect.width;
      const scaleY = drawCanvas.height / rect.height;
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    drawCanvas.addEventListener("mousedown", (e) => {
      e.preventDefault();
      drawing = true;
      const { x, y } = getScaledCoords(e.clientX, e.clientY);
      ctx.beginPath();
      ctx.moveTo(x, y);
    });
    drawCanvas.addEventListener("mousemove", (e) => {
      e.preventDefault();
      if (!drawing) return;
      const { x, y } = getScaledCoords(e.clientX, e.clientY);
      ctx.lineTo(x, y);
      ctx.stroke();
    });
    drawCanvas.addEventListener("mouseup", () => { drawing = false; });
    drawCanvas.addEventListener("mouseleave", () => { drawing = false; });

    // Touch events
    drawCanvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      if (e.touches.length > 0) {
        drawing = true;
        const { x, y } = getScaledCoords(e.touches[0].clientX, e.touches[0].clientY);
        ctx.beginPath();
        ctx.moveTo(x, y);
      }
    }, { passive: false });
    drawCanvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (!drawing || e.touches.length === 0) return;
      const { x, y } = getScaledCoords(e.touches[0].clientX, e.touches[0].clientY);
      ctx.lineTo(x, y);
      ctx.stroke();
    }, { passive: false });
    drawCanvas.addEventListener("touchend", (e) => {
      e.preventDefault();
      drawing = false;
    });













    // ------------------ WORD LIMIT ------------------
    document.getElementById("description").addEventListener("input", (e) => {
      const desc = e.target.value.trim();
      const words = desc.split(/\s+/).filter(w => w.length > 0);
      const maxWords = 150;
      if (words.length > maxWords) {
        e.target.value = words.slice(0, maxWords).join(" ");
        statusMessage.textContent = `Description trimmed to ${maxWords} words.`;
        statusMessage.style.color = "red";
      } else {
        statusMessage.textContent = "";
        statusMessage.style.color = "#fffac4";
      }
    });



    

    // ------------------ FORM SUBMIT ------------------
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMessage.textContent = "Submitting...";
      statusMessage.style.color = "#fffac4";

      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const tagsInput = document.getElementById("tags").value.trim();
      const tags = tagsInput ? tagsInput.split(",").map(tag => tag.trim()) : [];

      let drawingBase64 = null;
      if (drawContainer.style.display === "block") {
        drawingBase64 = drawCanvas.toDataURL("image/png");
      }

      try {
        const { data, error } = await supabase
          .from("projects")
          .insert([
            {
              title,
              description,
              tags,
              image_data: drawingBase64,
              upvotes: 0
            },
          ])
          .select();

        if (error) throw error;

        statusMessage.textContent = "Submission successful!";
        statusMessage.style.color = "#fffac4";

        // Reset form
        uploadForm.reset();
        ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
        drawContainer.style.display = "none";
        submissionFormContainer.classList.remove('open');
        if (window.innerWidth <= 600) {
          document.body.classList.remove('lock-scroll');
        }

        // Reload projects and tags
        currentPage = 1;
        await renderPage(currentPage);
        await fetchAndPopulateTags();

      } catch (err) {
        console.error("Error:", err);
        statusMessage.textContent = `Submission failed: ${err.message}`;
        statusMessage.style.color = "red";
      }
    });

    async function fetchAndPopulateTags() {
  const { data, error } = await supabase.from("projects").select("tags");

  if (error) {
    console.error("Error fetching tags:", error);
    return;
  }

  const allTags = data.flatMap((proj) => proj.tags || []);
  const uniqueTags = Array.from(new Set(allTags)).sort();

  // Clear existing options
  tagsDropdown.innerHTML = "";

  // Add default "Search Tags" option as a placeholder
  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "Filter";
  defaultOption.disabled = true; // Prevent selection
  defaultOption.selected = true; // Show as default
  tagsDropdown.appendChild(defaultOption);

  // Add "All" option
  const allOption = document.createElement("option");
  allOption.value = "All";
  allOption.textContent = "All";
  tagsDropdown.appendChild(allOption);

  // Add unique tags
  uniqueTags.forEach((tag) => {
    const option = document.createElement("option");
    option.value = tag;
    option.textContent = tag;
    tagsDropdown.appendChild(option);
  });
}

// Update the event listener for dropdown change
tagsDropdown.addEventListener("change", () => {
  const val = tagsDropdown.value;
  if (val === "All") {
    currentFilterTag = null; // Reset to show all projects
  } else {
    currentFilterTag = val;
  }
  currentPage = 1;
  renderPage(currentPage);
});


    // ------------------ FETCH PROJECTS ------------------
    async function fetchProjects(page, tag = null, search = "") {
      const offset = (page - 1) * PAGE_SIZE;
      let query = supabase
        .from("projects")
        .select("id, title, description, tags, image_data, upvotes")
        .order("id", { ascending: false })
        .range(offset, offset + PAGE_SIZE - 1);

      if (tag) {
        query = query.contains('tags', [tag]);
      }
      if (search.length > 0) {
        query = query.or(`title.ilike.%${search}%,description.ilike.%${search}%`);
      }
      const { data, error } = await query;
      if (error) {
        console.error("Error fetching projects:", error);
        projectListEl.innerHTML = `<p style="padding:20px; color: #fffac4;">Error loading projects: ${error.message}</p>`;
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
        return [];
      }
      return data || [];
    }

    // ------------------ RENDER PAGE ------------------
    async function renderPage(page, forceReload = false) {
      const projects = await fetchProjects(page, currentFilterTag, searchTerm);
      if (projects.length === 0 && page === 1) {
        projectListEl.innerHTML = `<p style='padding:20px; color: #fffac4;'>No projects uploaded yet.</p>`;
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
        return;
      }
      if (projects.length === 0 && page > 1) {
        currentPage--;
        return;
      }

      projectListEl.innerHTML = "";
      // If scatter mode, give #projectList a big space (height: 120vh).
      // If grid mode, let it auto-size.
      if (isGridView) {
        projectListEl.style.height = "auto";
      } else {
        projectListEl.style.height = "120vh";
      }
      if (forceReload) {
        savedPositions = [];
      }

      appendProjects(projects);

      // Check pagination
      if (projects.length < PAGE_SIZE) {
        totalLastPage = currentPage;
        nextPageBtn.disabled = true;
      } else {
        nextPageBtn.disabled = false;
      }
      prevPageBtn.disabled = (currentPage === 1);
    }

    function appendProjects(projects) {
      const newElems = [];
      projects.forEach((project) => {
        const projDiv = document.createElement("div");
        projDiv.classList.add("project");

        // For upvotes
        const upvoteHTML = `
          <div class="upvote-container">
            <button class="upvoteBtn" data-id="${project.id}">↑</button>
            <span class="upvoteCount">${project.upvotes ?? 0}</span>
          </div>
        `;

        let contentHTML = "";
        if (project.image_data) {
          projDiv.classList.add("has-image");
          contentHTML = `
            <div class="image-overlay" style="background-image: url('${escapeURL(project.image_data)}');"></div>
            <div class="project-info">
              <h2 class="title">${escapeHTML(project.title)}</h2>
              <p class="description">${escapeHTML(project.description)}</p>
              ${
                project.tags && project.tags.length
                  ? `<p class="tags"><strong>Tags:</strong> ${project.tags.map(escapeHTML).join(", ")}</p>`
                  : ""
              }
            </div>
          `;
        } else {
          contentHTML = `
            <div class="project-info">
              <h2 class="title">${escapeHTML(project.title)}</h2>
              <p class="description">${escapeHTML(project.description)}</p>
              ${
                project.tags && project.tags.length
                  ? `<p class="tags"><strong>Tags:</strong> ${project.tags.map(escapeHTML).join(", ")}</p>`
                  : ""
              }
            </div>
          `;
        }
        projDiv.innerHTML = upvoteHTML + contentHTML;
        projectListEl.appendChild(projDiv);
        newElems.push({ element: projDiv, data: project });
      });

      // If in scatter mode, absolutely position them via .scattered
      if (!isGridView) {
        positionProjects(newElems);
      }
      // Upvote button logic
      newElems.forEach(({ element, data }) => {
        const upvoteBtn = element.querySelector(".upvoteBtn");
        if (upvoteBtn) {
          upvoteBtn.addEventListener("click", () => handleUpvote(data.id, element));
        }
      });
    }

    function positionProjects(newElems) {
      const containerRect = projectListEl.getBoundingClientRect();

      newElems.forEach(({ element, data }, index) => {
        // Switch from default relative -> absolute
        element.classList.add("scattered");

        // Randomize positions within container
        const projWidth = element.offsetWidth;
        const projHeight = element.offsetHeight;
        const maxX = containerRect.width - projWidth;
        const maxY = containerRect.height - projHeight;
        const x = Math.random() * maxX;
        const y = Math.random() * maxY;

        element.style.left = x + "px";
        element.style.top = y + "px";
        element.style.zIndex = zIndexCounter;

        savedPositions.push({ left: x, top: y, zIndex: zIndexCounter });
      });
    }

    async function handleUpvote(projectId, projectEl) {
  try {
    // Fetch the current upvotes for the project
    const { data: existing } = await supabase
      .from("projects")
      .select("upvotes")
      .eq("id", projectId)
      .single();

    // Get the current upvote count, default to 0 if NULL
    const currentUpvotes = existing.upvotes || 0;

    // Increment the upvote count
    const updatedUpvotes = currentUpvotes + 1;

    // Update the upvote count in the database
    await supabase
      .from("projects")
      .update({ upvotes: updatedUpvotes })
      .eq("id", projectId);

    // Update the UI with the new upvote count
    const upvoteCountEl = projectEl.querySelector(".upvoteCount");
    if (upvoteCountEl) {
      upvoteCountEl.textContent = updatedUpvotes;
    }

    // Disable the upvote button and mark it as "clicked"
    const upvoteBtn = projectEl.querySelector(".upvoteBtn");
    if (upvoteBtn) {
      upvoteBtn.disabled = true;
      upvoteBtn.classList.add("clicked"); // Add a class to style the button as active
    }
  } catch (err) {
    console.error("Error updating upvote:", err);
  }
}




    // ------------------ DRAG HANDLERS (Scatter Mode) ------------------
    function startDrag(e) {
      // If grid, ignore drag.
      if (isGridView) return;
      const target = e.target.closest(".project");
      if (!target) return;

      isDragging = true;
      activeElement = target;

      const containerRect = projectListEl.getBoundingClientRect();
      const rect = activeElement.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;

      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;

      zIndexCounter++;
      activeElement.style.zIndex = zIndexCounter;
      activeElement.classList.add("dragging");
      e.preventDefault();
    }

    function onMove(e) {
      if (isGridView || !isDragging || !activeElement) return;

      const containerRect = projectListEl.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;

      let newX = clientX - containerRect.left - offsetX;
      let newY = clientY - containerRect.top - offsetY;

      const projWidth = activeElement.offsetWidth;
      const projHeight = activeElement.offsetHeight;
      newX = Math.max(0, Math.min(containerRect.width - projWidth, newX));
      newY = Math.max(0, Math.min(containerRect.height - projHeight, newY));

      velocityX = newX - parseFloat(activeElement.style.left || 0);
      velocityY = newY - parseFloat(activeElement.style.top || 0);

      activeElement.style.left = `${newX}px`;
      activeElement.style.top = `${newY}px`;
    }

    function endDrag() {
      if (isGridView || !isDragging || !activeElement) return;
      isDragging = false;
      activeElement.classList.remove("dragging");
      activeElement.classList.add("dropped");
      activeElement.addEventListener("animationend", function handleAnimationEnd() {
        activeElement.classList.remove("dropped");
        activeElement.removeEventListener("animationend", handleAnimationEnd);
      });
      const allProjects = Array.from(projectListEl.querySelectorAll(".project"));
      const index = allProjects.indexOf(activeElement);
      if (index > -1 && savedPositions[index]) {
        savedPositions[index].left = parseFloat(activeElement.style.left);
        savedPositions[index].top = parseFloat(activeElement.style.top);
        savedPositions[index].zIndex = parseInt(activeElement.style.zIndex);
      }
      requestAnimationFrame(applyMomentum);
    }

    function applyMomentum() {
      if (isGridView || isDragging || !activeElement) return;
      const containerRect = projectListEl.getBoundingClientRect();
      let newX = parseFloat(activeElement.style.left || 0) + velocityX;
      let newY = parseFloat(activeElement.style.top || 0) + velocityY;

      velocityX *= friction;
      velocityY *= friction;

      const projWidth = activeElement.offsetWidth;
      const projHeight = activeElement.offsetHeight;
      newX = Math.max(0, Math.min(containerRect.width - projWidth, newX));
      newY = Math.max(0, Math.min(containerRect.height - projHeight, newY));

      activeElement.style.left = `${newX}px`;
      activeElement.style.top = `${newY}px`;

      const allProjects = Array.from(projectListEl.querySelectorAll(".project"));
      const index = allProjects.indexOf(activeElement);
      if (index > -1 && savedPositions[index]) {
        savedPositions[index].left = newX;
        savedPositions[index].top = newY;
      }
      if (Math.abs(velocityX) > 0.5 || Math.abs(velocityY) > 0.5) {
        requestAnimationFrame(applyMomentum);
      }
    }

    // ------------------ UTILITIES ------------------
    function escapeHTML(str = "") {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function escapeURL(url = "") {
      return url.replace(/"/g, "%22").replace(/'/g, "%27");
    }

    // ------------------ PAGINATION ------------------
    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    });
    nextPageBtn.addEventListener("click", () => {
      currentPage++;
      renderPage(currentPage);
    });

    // ------------------ INIT ------------------
    document.addEventListener("DOMContentLoaded", async () => {
      projectListEl.classList.add("grid-mode"); // Start in grid mode
      layoutToggleBtn.textContent = "Switch to Scatter";

      await fetchAndPopulateTags();
      renderPage(currentPage);
      animateTitle();
    });

    function animateTitle() {
      const title = document.getElementById("animated-title");
      const letters = title.querySelectorAll(".letter");
      letters.forEach((letter, index) => {
        const delay = 500 + index * 100 + Math.random() * 100;
        setTimeout(() => {
          letter.classList.add("visible");
        }, delay);
      });
    }

    // Global drag events
    document.addEventListener("mousedown", startDrag, false);
    document.addEventListener("mousemove", onMove, false);
    document.addEventListener("mouseup", endDrag, false);
    document.addEventListener("touchstart", startDrag, { passive: false });
    document.addEventListener("touchmove", onMove, { passive: false });
    document.addEventListener("touchend", endDrag, false);
  </script>
</body>
</html>
